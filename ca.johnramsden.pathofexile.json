{
    "app-id": "ca.johnramsden.pathofexile",
    "runtime": "org.freedesktop.Platform/x86_64", 
    "sdk": "org.freedesktop.Sdk/x86_64", 
    "runtime-version": "1.6",
    "branch": "64bit",
    "tags": ["proprietary"],
    "command": "pathofexile.sh",
    "add-build-extensions": {
        "org.freedesktop.Platform.Compat32": {
            "directory": "lib/32bit",
            "add-ld-path": "lib",
            "version": "1.6"
        }
    },
    "build-options": {
      "cflags": "-O1 -pipe",
      "env": {
        "WINEPREFIX": "/var/data/.local/share/pathofexile",
        "WINEDLLOVERRIDES": "mscoree=d;mshtml=d",
        "V": "0"
      }
    },
    "finish-args": [
       "--persist=.local/share/pathofexile_x64",
       "--socket=x11",
       "--share=network",
       "--share=ipc",
       "--device=dri",
       "--allow=multiarch",
       "--socket=pulseaudio",
       "--filesystem=/var/log:ro",
       "--filesystem=xdg-documents",
       "--env=WINEDEBUG=-all",
       "--env=WINE_RESOLUTION=1920x1080",
       "--env=VIDEO_MEMORY=",
       "--env=WINE=/app/bin/wine",
       "--env=LD_LIBRARY_PATH=/app/lib:/app/lib/32bit",
       "--extension=org.freedesktop.Platform.Compat32=directory=lib/32bit",
       "--extension=org.freedesktop.Platform.Compat32=version=1.6",
       "--extension=org.freedesktop.Platform.GL32=directory=lib/32bit/lib/GL",
       "--extension=org.freedesktop.Platform.GL32=version=1.4",
       "--extension=org.freedesktop.Platform.GL32=versions=1.6;1.4",
       "--extension=org.freedesktop.Platform.GL32=subdirectories=true",
       "--extension=org.freedesktop.Platform.GL32=no-autodownload=true",
       "--extension=org.freedesktop.Platform.GL32=autodelete=false",
       "--extension=org.freedesktop.Platform.GL32=add-ld-path=lib",
       "--extension=org.freedesktop.Platform.GL32=merge-dirs=vulkan/icd.d;glvnd/egl_vendor.d",
       "--extension=org.freedesktop.Platform.GL32=download-if=active-gl-driver",
       "--extension=org.freedesktop.Platform.GL32=enable-if=active-gl-driver"
    ],
    "modules": [
        {
            "name": "setup-32bit",
            "buildsystem": "simple",
            "build-commands": [
                "ln -s /app/lib/32bit/lib/ld-linux.so.2 /app/lib/ld-linux.so.2",
                "install -Dm644 ld.so.conf /app/etc/ld.so.conf"
            ],
            "sources": [
                {
                    "type": "file",
                    "path": "ld.so.conf"
                }
            ]
        },
        {
            "name": "wine",
            "buildsystem": "simple",
            "build-commands": [
              "chmod +x winebuild.sh && ./winebuild.sh"
            ],
            "no-make-install": true,
            "cleanup": [
                "/bin/function_grep.pl",
                "/bin/msiexec",
                "/bin/widl",
                "/bin/wine64-preloader",
                "/bin/winebuild",
                "/bin/wineconsole",
                "/bin/winedbg",
                "/bin/winefile",
                "/bin/winegcc",
                "/bin/winemine",
                "/bin/wrc",
                "/bin/msidb",
                "/bin/notepad",
                "/bin/regsvr32",
                "/bin/wineboot",
                "/bin/winecfg",
                "/bin/winecpp",
                "/bin/winedump",
                "/bin/wineg++",
                "/bin/winemaker",
                "/bin/winepath",
                "/bin/wmc",
                "/include",
                "/share/man",
                "/share/applications"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://dl.winehq.org/wine/source/3.x/wine-3.6.tar.xz",
                    "sha256": "78502dc79a60430d2a2ef66bee146e38eb6dd679fd36b54acfc8f9b2ac07905c"
                },
                {
                    "type": "archive",
                    "url": "https://github.com/wine-staging/wine-staging/archive/v3.6.tar.gz",
                    "sha256": "2ec8fc3f8edc282e4ed94ccb7c67524503b02909affc24499ea6bdf7e734bb3f"
                },
                {
                    "type": "shell",
                    "commands": [ "./patches/patchinstall.sh DESTDIR=$(pwd) --all" ]
                },
                {
                    "type": "file",
                    "path": "winebuild.sh"
                }
            ]
        },
        {
            "name": "winetricks",
            "buildsystem": "simple",
            "build-commands": [
              "make",
              "make PREFIX=/app install",
              "chmod +x /app/bin/winetricks"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/Winetricks/winetricks/archive/20180217.tar.gz",
                    "sha256": "10e11dd150f1629af17f5549404d66b17968130cbdec6a4524b51d9291484a47"
                }
            ]
        },
        {
            "name": "cabextract",
            "buildsystem": "autotools",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://www.cabextract.org.uk/cabextract-1.6.tar.gz",
                    "sha256": "cee661b56555350d26943c5e127fc75dd290b7f75689d5ebc1f04957c4af55fb"
                }
            ]
        },
        {
            "name": "wine-gecko",
            "buildsystem": "simple",
            "build-commands": [
              "mkdir -p ${WINEPREFIX}",
              "install -D wine_gecko-2.47-x86_64.msi /app/share/wine/gecko/wine_gecko-2.47-x86_64.msi"
            ],
            "no-make-install": true,
            "sources": [
                {
                    "type": "file",
                    "url": "http://dl.winehq.org/wine/wine-gecko/2.47/wine_gecko-2.47-x86_64.msi",
                    "sha256": "c565ea25e50ea953937d4ab01299e4306da4a556946327d253ea9b28357e4a7d"
                }
            ]
        },
        {
            "name": "wine-mono",
            "buildsystem": "simple",
            "build-commands": [
              "install -D wine-mono-4.7.1.msi /app/share/wine/mono/wine-mono-4.7.1.msi"
            ],
            "no-make-install": true,
            "sources": [
                {
                    "type": "file",
                    "url": "http://dl.winehq.org/wine/wine-mono/4.7.1/wine-mono-4.7.1.msi",
                    "sha256": "2c8d5db7f833c3413b2519991f5af1f433d59a927564ec6f38a3f1f8b2c629aa"
                }
            ]
        },
        {
            "name": "wget",
            "buildsystem": "autotools",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://ftp.gnu.org/gnu/wget/wget-1.19.tar.xz",
                    "sha256": "0f1157bbf4daae19f3e1ddb70c6ccb2067feb834a6aa23c9d9daa7f048606384"
                }
            ]
        },
        {
            "name": "pathofexile-installer",
            "buildsystem": "simple",
            "build-commands": [ 
                "install --directory ${WINEPREFIX}",
                "install pathofexile.sh /app/bin"
            ],
            "no-make-install": true,
            "sources": [
                {
                "type": "file",
                "path": "pathofexile.sh"
                }
            ]
        },
        {
            "name": "icons",
            "buildsystem": "simple",
            "build-commands": [ 
                "install -D --mode=644 pathofexile-256.png /app/share/icons/hicolor/256x256/apps/ca.johnramsden.pathofexile.png"
            ],
            "no-make-install": true,
            "sources": [
                {
                "type": "file",
                "path": "pathofexile-256.png",
                "sha256": "812ffce2eef92b9b4efac0674e9dcfb56dd66989b2d005e1742a6ed6d1ad2d7f"
                }
            ]
        },
        {
            "name": "desktop",
            "buildsystem": "simple",
            "build-commands": [ 
                "install -D --mode=644 pathofexile.desktop /app/share/applications/ca.johnramsden.pathofexile.desktop"
            ],
            "no-make-install": true,
            "sources": [
                {
                "type": "file",
                "path": "pathofexile.desktop"
                }
            ]
        },
        {
            "name": "metadata",
            "buildsystem": "simple",
            "build-commands": [ 
                "install -D --mode=644 ca.johnramsden.pathofexile.appdata.xml /app/share/metainfo/ca.johnramsden.pathofexile.appdata.xml"
            ],
            "no-make-install": true,
            "sources": [
                {
                "type": "file",
                "path": "ca.johnramsden.pathofexile.appdata.xml"
                }
            ]
        }
    ]
}
